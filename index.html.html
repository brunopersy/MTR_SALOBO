<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GD Material Rodante</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;600;700;800&family=Barlow:wght@300;400;500;600&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#080b0f; --s1:#0d1117; --s2:#111620; --s3:#161c28;
  --border:#1d2535; --accent:#e8a020;
  --danger:#e83a3a; --warn:#e8a020; --ok:#27c98a; --info:#3a8fe8;
  --muted:#3d4d65; --t1:#eaf0ff; --t2:#8899bb; --t3:#4a5a7a;
  --mono:'JetBrains Mono',monospace;
  --cond:'Barlow Condensed',sans-serif;
  --body:'Barlow',sans-serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--t1);font-family:var(--body);font-size:14px}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,#00000012 2px,#00000012 4px);pointer-events:none;z-index:9999}
header{height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 24px;background:var(--s1);border-bottom:1px solid var(--border);position:relative;z-index:100}
.logo-wrap{display:flex;align-items:center;gap:14px}
.logo-icon{width:36px;height:36px;border:2px solid var(--accent);border-radius:4px;display:flex;align-items:center;justify-content:center;font-family:var(--cond);font-weight:800;font-size:14px;color:var(--accent);letter-spacing:.05em}
.logo-text{font-family:var(--cond);font-weight:700;font-size:18px;letter-spacing:.12em}
.logo-sub{font-family:var(--mono);font-size:9px;color:var(--t3);letter-spacing:.2em;text-transform:uppercase;margin-top:1px}
.header-right{display:flex;align-items:center;gap:20px}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--ok);animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.header-ts{font-family:var(--mono);font-size:10px;color:var(--t3)}
.layout{display:grid;grid-template-columns:260px 1fr 340px;grid-template-rows:80px calc(100vh - 56px - 80px);height:calc(100vh - 56px)}
.kpi-row{grid-column:1/-1;display:grid;grid-template-columns:repeat(6,1fr);border-bottom:1px solid var(--border);background:var(--s1)}
.kpi{padding:0 20px;display:flex;flex-direction:column;justify-content:center;border-right:1px solid var(--border);position:relative;overflow:hidden;cursor:default;transition:background .2s}
.kpi:hover{background:var(--s2)}
.kpi:last-child{border-right:none}
.kpi::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px}
.kpi.danger::after{background:var(--danger)}
.kpi.warn::after{background:var(--warn)}
.kpi.ok::after{background:var(--ok)}
.kpi.info::after{background:var(--info)}
.kpi.neutral::after{background:var(--muted)}
.kl{font-family:var(--mono);font-size:8px;color:var(--t3);letter-spacing:.18em;text-transform:uppercase;margin-bottom:2px}
.kv{font-family:var(--cond);font-size:28px;font-weight:700;line-height:1}
.kpi.danger .kv{color:var(--danger)}
.kpi.warn .kv{color:var(--warn)}
.kpi.ok .kv{color:var(--ok)}
.kpi.info .kv{color:var(--info)}
.kpi.neutral .kv{color:var(--t1)}
.ks{font-size:10px;color:var(--t3);margin-top:2px}
.sidebar{border-right:1px solid var(--border);overflow-y:auto;background:var(--s1)}
.sb-head{padding:10px 14px 6px;font-family:var(--mono);font-size:8px;color:var(--t3);letter-spacing:.2em;text-transform:uppercase;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--s1);z-index:5;display:flex;align-items:center;gap:8px}
.sb-ct{background:var(--s3);border-radius:3px;padding:1px 6px;font-size:9px}
.sb-ct.danger{color:var(--danger)}
.sb-ct.warn{color:var(--warn)}
.sb-ct.ok{color:var(--ok)}
.item-row{display:flex;align-items:center;gap:10px;padding:8px 14px;border-bottom:1px solid #0d111a;cursor:pointer;transition:background .15s}
.item-row:hover{background:var(--s2)}
.item-row.active{background:var(--s3);border-left:2px solid var(--accent)}
.ir-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.ir-dot.danger{background:var(--danger);box-shadow:0 0 6px #e83a3a88}
.ir-dot.warn{background:var(--warn);box-shadow:0 0 6px #e8a02055}
.ir-dot.ok{background:var(--ok)}
.ir-body{flex:1;min-width:0}
.ir-tag{font-family:var(--cond);font-weight:600;font-size:13px;letter-spacing:.06em}
.ir-sub{font-family:var(--mono);font-size:9px;color:var(--t3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ir-badge{font-family:var(--mono);font-size:8px;font-weight:600;padding:2px 5px;border-radius:2px;text-transform:uppercase;white-space:nowrap;flex-shrink:0}
.ir-badge.danger{background:#e83a3a22;color:var(--danger);border:1px solid #e83a3a33}
.ir-badge.warn{background:#e8a02022;color:var(--warn);border:1px solid #e8a02033}
.ir-badge.ok{background:#27c98a22;color:var(--ok);border:1px solid #27c98a33}
.main{overflow-y:auto;background:var(--bg)}
.detail{padding:24px}
.empty{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--muted);font-family:var(--mono);font-size:12px}
.empty-icon{font-size:48px;opacity:.2}
.dh{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;gap:20px;padding-bottom:16px;border-bottom:1px solid var(--border)}
.dh-tag{font-family:var(--cond);font-weight:800;font-size:36px;letter-spacing:.1em;line-height:1}
.dh-modelo{font-family:var(--mono);font-size:10px;color:var(--t3);letter-spacing:.15em;margin-top:3px}
.dh-meta{display:flex;flex-wrap:wrap;gap:16px;margin-top:8px;font-family:var(--mono);font-size:9px;color:var(--t2)}
.dh-meta span{display:flex;align-items:center;gap:4px}
.dh-right{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
.status-big{font-family:var(--cond);font-weight:700;font-size:13px;letter-spacing:.15em;padding:4px 10px;border-radius:3px;text-transform:uppercase}
.status-big.danger{background:#e83a3a22;color:var(--danger);border:1px solid #e83a3a44}
.status-big.warn{background:#e8a02022;color:var(--warn);border:1px solid #e8a02044}
.status-big.ok{background:#27c98a22;color:var(--ok);border:1px solid #27c98a44}
.urgencia{font-family:var(--cond);font-size:22px;font-weight:700;text-align:right}
.urgencia.danger{color:var(--danger)}
.urgencia.warn{color:var(--warn)}
.urgencia-label{font-family:var(--mono);font-size:8px;color:var(--t3);text-align:right;letter-spacing:.1em}
.vida-row{display:flex;align-items:center;gap:12px;margin-bottom:20px}
.vida-label{font-family:var(--mono);font-size:9px;color:var(--t3);letter-spacing:.1em;text-transform:uppercase;white-space:nowrap}
.vida-bar{flex:1;height:5px;background:var(--border);border-radius:3px;overflow:hidden}
.vida-fill{height:100%;border-radius:3px;transition:width .6s}
.vida-pct{font-family:var(--cond);font-weight:700;font-size:18px;width:52px;text-align:right}
.st{font-family:var(--mono);font-size:8px;color:var(--t3);letter-spacing:.2em;text-transform:uppercase;padding-bottom:8px;margin-bottom:12px;border-bottom:1px solid var(--border)}
.med-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;margin-bottom:20px}
.med-card{background:var(--s1);border:1px solid var(--border);border-radius:5px;padding:10px 12px;position:relative;overflow:hidden;transition:border-color .2s}
.med-card.bad{border-color:#e83a3a44;background:#e83a3a06}
.med-label{font-family:var(--mono);font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px}
.med-val{font-family:var(--cond);font-weight:700;font-size:22px;line-height:1}
.med-val.bad{color:var(--danger)}
.med-unit{font-family:var(--body);font-size:9px;color:var(--t3);margin-top:2px}
.med-dev{position:absolute;top:6px;right:6px;font-family:var(--mono);font-size:7px;font-weight:600;color:var(--danger);background:#e83a3a22;padding:1px 4px;border-radius:2px}
.rol-sup-row{display:flex;gap:6px;margin-bottom:20px}
.rol-chip{flex:1;background:var(--s1);border:1px solid var(--border);border-radius:4px;padding:6px 8px;text-align:center}
.rol-chip.bad{border-color:#e83a3a44;background:#e83a3a06}
.rol-chip-label{font-family:var(--mono);font-size:7px;color:var(--t3);text-transform:uppercase}
.rol-chip-val{font-family:var(--cond);font-weight:700;font-size:16px;color:var(--t1)}
.rol-chip.bad .rol-chip-val{color:var(--danger)}
.dev-row{display:flex;align-items:center;gap:12px;padding:6px 0;border-bottom:1px solid #0d111a}
.dev-row:last-child{border-bottom:none}
.dev-label{flex:1;font-size:12px}
.dev-bar{width:80px;height:3px;background:var(--border);border-radius:2px;overflow:hidden;flex-shrink:0}
.dev-fill{height:100%;border-radius:2px}
.dev-pct{font-family:var(--mono);font-size:9px;color:var(--danger);width:44px;text-align:right;flex-shrink:0}
.chat-col{border-left:1px solid var(--border);background:var(--s1);display:flex;flex-direction:column;overflow:hidden}
.chat-hdr{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-shrink:0}
.chat-title{font-family:var(--cond);font-weight:600;font-size:13px;letter-spacing:.1em}
.chat-ai-dot{width:8px;height:8px;border-radius:50%;background:var(--ok);animation:blink 3s infinite}
.quick-row{display:flex;flex-wrap:wrap;gap:5px;padding:10px 12px;border-bottom:1px solid var(--border);flex-shrink:0}
.qbtn{font-family:var(--mono);font-size:8px;color:var(--t3);border:1px solid var(--border);background:transparent;border-radius:3px;padding:3px 7px;cursor:pointer;transition:all .15s;line-height:1.4;text-align:left}
.qbtn:hover{border-color:var(--accent);color:var(--accent)}
.chat-msgs{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
.msg{max-width:95%;padding:8px 10px;border-radius:5px;font-size:11px;line-height:1.55;animation:msgIn .2s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.msg.user{align-self:flex-end;background:#1b2b1b;border:1px solid #27c98a33;color:var(--ok);font-family:var(--mono);font-size:10px}
.msg.agent{align-self:flex-start;background:var(--s3);border:1px solid var(--border);color:var(--t1);white-space:pre-wrap}
.msg.loading{align-self:flex-start;background:var(--s3);border:1px solid var(--border);color:var(--t3);font-family:var(--mono);font-size:10px}
.chat-input-row{padding:10px 12px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:center;flex-shrink:0}
.ci{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:7px 10px;color:var(--t1);font-family:var(--mono);font-size:10px;outline:none;transition:border-color .2s}
.ci:focus{border-color:var(--accent)}
.ci::placeholder{color:var(--t3)}
.cs{background:var(--accent);color:#080b0f;border:none;border-radius:4px;padding:7px 14px;font-family:var(--mono);font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;cursor:pointer;transition:opacity .2s}
.cs:hover{opacity:.85}
.cs:disabled{opacity:.4;cursor:default}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
</style>
</head>
<body>

<header>
  <div class="logo-wrap">
    <div class="logo-icon">GD</div>
    <div>
      <div class="logo-text">MATERIAL RODANTE</div>
      <div class="logo-sub">Ger. de Maquinas &bull; DR416i + FlexiROC D65</div>
    </div>
  </div>
  <div class="header-right">
    <div class="live-dot"></div>
    <div class="header-ts" id="ts"></div>
  </div>
</header>

<div class="layout">
  <div class="kpi-row">
    <div class="kpi danger"><div class="kl">Criticos</div><div class="kv" id="kCrit">0</div><div class="ks">substituicao urgente</div></div>
    <div class="kpi warn"><div class="kl">Atencao</div><div class="kv" id="kAten">0</div><div class="ks">programar substituicao</div></div>
    <div class="kpi ok"><div class="kl">OK</div><div class="kv" id="kOk">0</div><div class="ks">dentro dos parametros</div></div>
    <div class="kpi neutral"><div class="kl">Total Inspecoes</div><div class="kv" id="kTotal">0</div><div class="ks">este ciclo</div></div>
    <div class="kpi info"><div class="kl">Equipamentos</div><div class="kv" id="kEquip">0</div><div class="ks">TAGs unicos</div></div>
    <div class="kpi neutral"><div class="kl">Ultima Inspecao</div><div class="kv" id="kData" style="font-size:16px;margin-top:4px">--</div><div class="ks" id="kAnalista">--</div></div>
  </div>

  <aside class="sidebar">
    <div class="sb-head"><span>Criticos</span><span class="sb-ct danger" id="scCrit">0</span></div>
    <div id="listCrit"></div>
    <div class="sb-head"><span>Atencao</span><span class="sb-ct warn" id="scAten">0</span></div>
    <div id="listAten"></div>
    <div class="sb-head"><span>OK</span><span class="sb-ct ok" id="scOk">0</span></div>
    <div id="listOk"></div>
  </aside>

  <div class="main" id="mainPanel">
    <div class="detail"><div class="empty"><div class="empty-icon">&#9881;</div><div>Selecione um registro na lista</div></div></div>
  </div>

  <div class="chat-col">
    <div class="chat-hdr"><div class="chat-ai-dot"></div><div class="chat-title">AGENTE PCM &bull; IA</div></div>
    <div class="quick-row">
      <button class="qbtn" onclick="qask('Gere o cronograma de substituicoes das proximas 4 semanas por TAG, lado, componente e urgencia')">Cronograma PCM</button>
      <button class="qbtn" onclick="qask('Quais TAGs tem maior risco de parada nao planejada? Explique o risco operacional')">Risco de Parada</button>
      <button class="qbtn" onclick="qask('Compare desgaste entre LC e LNC de cada TAG. Ha assimetria?')">LC vs LNC</button>
      <button class="qbtn" onclick="qask('Liste todos componentes acima de 80% de desgaste ordenados por criticidade')">Desgaste maior 80%</button>
      <button class="qbtn" onclick="qask('Qual impacto de adiar substituicoes criticas por 15 dias?')">Impacto Adiamento</button>
    </div>
    <div class="chat-msgs" id="chatMsgs">
      <div class="msg agent">Ola! Dados carregados com os parametros reais do fabricante (DR416i e FlexiROC D65). Selecione um item ou use os atalhos acima para analises do PCM.</div>
    </div>
    <div class="chat-input-row">
      <input class="ci" id="ci" placeholder="Pergunte sobre os dados de inspecao..." onkeydown="if(event.key==='Enter')send()"/>
      <button class="cs" id="csbtn" onclick="send()">ENVIAR</button>
    </div>
  </div>
</div>

<script>
// =========================================================
// PARAMETROS REAIS DO FABRICANTE
// Fonte: Lista "Parametros" do Microsoft Lists
// novo  = valor da peca nova
// limite = limite de desgaste (ponto de substituicao)
// tipo min: medicao ABAIXO do limite -> substituir
// tipo max: medicao ACIMA do limite  -> substituir (passo elongado)
// =========================================================
var PARAMS = {
  "Pit Viper/DR416i": {
    roda_guia:  {novo:22.5,   limite:34.5,   tipo:"min", unit:"mm"},
    elo:        {novo:155.5,  limite:142.5,  tipo:"min", unit:"mm"},
    motriz:     {novo:284,    limite:270,    tipo:"min", unit:"mm"},
    rolete_sup: {novo:190,    limite:167.5,  tipo:"min", unit:"mm"},
    sapata:     {novo:85,     limite:70.6,   tipo:"min", unit:"mm"},
    passo:      {novo:1042.5, limite:1055.5, tipo:"max", unit:"mm"},
    bucha:      {novo:14,     limite:10.7,   tipo:"min", unit:"mm"},
    rolete_inf: {novo:73.9,   limite:61.2,   tipo:"min", unit:"mm"},
    danif_atencao:1, danif_critico:3, vida_util:50000
  },
  "FlexiROC D65": {
    roda_guia:  {novo:17.5,  limite:25.5,   tipo:"min", unit:"mm"},
    elo:        {novo:89,    limite:84.2,   tipo:"min", unit:"mm"},
    motriz:     {novo:185,   limite:165,    tipo:"min", unit:"mm"},
    rolete_sup: {novo:100,   limite:92,     tipo:"min", unit:"mm"},
    sapata:     {novo:25,    limite:6,      tipo:"min", unit:"mm"},
    passo:      {novo:686,   limite:698.7,  tipo:"max", unit:"mm"},
    bucha:      {novo:8.2,   limite:3.2,    tipo:"min", unit:"mm"},
    rolete_inf: {novo:43,    limite:36.5,   tipo:"min", unit:"mm"},
    danif_atencao:1, danif_critico:3, vida_util:30000
  }
};

function getP(modelo) {
  var keys = Object.keys(PARAMS);
  for (var i = 0; i < keys.length; i++) {
    if (modelo && modelo.toLowerCase().indexOf(keys[i].toLowerCase()) >= 0)
      return PARAMS[keys[i]];
  }
  return PARAMS["Pit Viper/DR416i"];
}

function isBad(val, p) {
  return p.tipo === "min" ? val < p.limite : val > p.limite;
}

function pctDeg(val, novo, limite) {
  var faixa = Math.abs(novo - limite);
  return faixa ? Math.min(Math.round(Math.abs(val - novo) / faixa * 100), 100) : 0;
}

// =========================================================
// DADOS MOCK (baseados nas screenshots reais)
// Em producao: substitua RAW por fetch() para a API Python
// =========================================================
var RAW = [
  {tag:"1101PF1601",modelo:"Pit Viper/DR416i",om:"202503926856",data:"2025-08-18",area:"FASE 6",
   horimetro:9240,analista:"BRUNO SILVA",lado:"LC (lado cabine)",
   roda_guia:25,elo:154,motriz:277,rol_sup:[189,189,189,189,189],sapata:81,passo:1045,bucha:13.8,rolete_inf:70.3,danif:0},
  {tag:"1101PF1601",modelo:"Pit Viper/DR416i",om:"202503926856",data:"2025-08-18",area:"FASE 6",
   horimetro:9240,analista:"BRUNO SILVA",lado:"LNC (lado nao cabine)",
   roda_guia:25,elo:154,motriz:278,rol_sup:[189,189,190,190,189],sapata:82.5,passo:1045,bucha:13.9,rolete_inf:70.5,danif:1},
  {tag:"1101PF1601",modelo:"Pit Viper/DR416i",om:"202504627719",data:"2025-09-19",area:"PATIO 320",
   horimetro:9553,analista:"BRUNO SILVA",lado:"LC (lado cabine)",
   roda_guia:22.5,elo:154,motriz:275,rol_sup:[189,189,189,189,189],sapata:81,passo:1045.5,bucha:13.7,rolete_inf:70.2,danif:0},
  {tag:"PZ1001SA02",modelo:"Pit Viper/DR416i",om:"202503858807",data:"2025-08-18",area:"PATIO 320",
   horimetro:45917,analista:"BRUNO SILVA",lado:"LC (lado cabine)",
   roda_guia:23,elo:152,motriz:282,rol_sup:[189,189,189,189,188],sapata:81,passo:1045,bucha:13.9,rolete_inf:69.3,danif:0},
  {tag:"PZ1001SA02",modelo:"Pit Viper/DR416i",om:"202503858807",data:"2025-08-18",area:"PATIO 320",
   horimetro:45917,analista:"BRUNO SILVA",lado:"LNC (lado nao cabine)",
   roda_guia:23,elo:153,motriz:280,rol_sup:[189,189,189,189,188],sapata:82,passo:1046,bucha:13.9,rolete_inf:69,danif:0},
  {tag:"PZ1001SA03",modelo:"Pit Viper/DR416i",om:"202503099260",data:"2025-08-01",area:"FASE 5",
   horimetro:39050,analista:"BRUNO SILVA",lado:"LC (lado cabine)",
   roda_guia:23,elo:155,motriz:283,rol_sup:[189,190,189,189,189],sapata:84,passo:1045,bucha:13.7,rolete_inf:64,danif:5},
  {tag:"PZ1001SA03",modelo:"Pit Viper/DR416i",om:"202503099260",data:"2025-08-01",area:"FASE 5",
   horimetro:39050,analista:"BRUNO SILVA",lado:"LNC (lado nao cabine)",
   roda_guia:24,elo:155,motriz:283,rol_sup:[189,190,189,190,189],sapata:84,passo:1045,bucha:13.9,rolete_inf:64.5,danif:0}
];

// =========================================================
// ANALISE
// =========================================================
function analisar(r) {
  var P = getP(r.modelo);
  var desvios = [];

  function chk(nome, val, p, label) {
    if (val == null) return;
    if (isBad(val, p)) {
      var dp = p.tipo === "min"
        ? parseFloat(((p.limite - val) / p.limite * 100).toFixed(1))
        : parseFloat(((val - p.limite) / p.limite * 100).toFixed(1));
      desvios.push({
        campo: label, medido: val, limite: p.limite, novo: p.novo,
        tipo: p.tipo, desvio_pct: dp,
        pct_deg: pctDeg(val, p.novo, p.limite)
      });
    }
  }

  chk("Roda Guia",   r.roda_guia,  P.roda_guia,  "Roda Guia - desgaste excessivo");
  chk("Elo",         r.elo,        P.elo,         "Elo - desgaste da corrente");
  chk("Motriz",      r.motriz,     P.motriz,      "Motriz - desgaste das garras");
  chk("Sapata",      r.sapata,     P.sapata,      "Sapata - espessura critica");
  chk("Passo",       r.passo,      P.passo,       "Passo - corrente elongada");
  chk("Bucha",       r.bucha,      P.bucha,       "Bucha - desgaste excessivo");
  chk("Rolete Inf.", r.rolete_inf, P.rolete_inf,  "Rolete Inferior - desgaste");
  for (var i = 0; i < r.rol_sup.length; i++)
    chk("Rol.Sup" + (i+1), r.rol_sup[i], P.rolete_sup, "Rolete Superior " + (i+1) + " - desgaste");

  if (r.danif >= P.danif_critico)
    desvios.push({campo:"Roletes Danificados - critico", medido:r.danif, limite:P.danif_critico, novo:0, tipo:"max", desvio_pct:100, pct_deg:100});
  else if (r.danif >= P.danif_atencao)
    desvios.push({campo:"Roletes Danificados - atencao", medido:r.danif, limite:P.danif_atencao, novo:0, tipo:"max", desvio_pct:50, pct_deg:50});

  var pctVida = parseFloat((r.horimetro / P.vida_util * 100).toFixed(1));
  var status = "OK";
  if (desvios.length) {
    var mx = Math.max.apply(null, desvios.map(function(d){return d.desvio_pct;}));
    status = (mx > 5 || pctVida > 90) ? "CRITICO" : "ATENCAO";
  } else if (pctVida > 80) status = "ATENCAO";

  var result = {};
  for (var k in r) result[k] = r[k];
  result.P = P;
  result.desvios = desvios;
  result.pctVida = pctVida;
  result.status = status;
  result.cls = status === "CRITICO" ? "danger" : status === "ATENCAO" ? "warn" : "ok";
  result.urgencia = status === "CRITICO" ? 7 : status === "ATENCAO" ? 30 : null;
  return result;
}

var ANALISES = RAW.map(analisar);
var CRITICOS = ANALISES.filter(function(a){return a.status === "CRITICO";});
var ATENCAO  = ANALISES.filter(function(a){return a.status === "ATENCAO";});
var OK       = ANALISES.filter(function(a){return a.status === "OK";});

// =========================================================
// KPIs
// =========================================================
document.getElementById("ts").textContent = new Date().toLocaleString("pt-BR");
document.getElementById("kCrit").textContent  = CRITICOS.length;
document.getElementById("kAten").textContent  = ATENCAO.length;
document.getElementById("kOk").textContent    = OK.length;
document.getElementById("kTotal").textContent = ANALISES.length;
var tags = {};
ANALISES.forEach(function(a){tags[a.tag]=1;});
document.getElementById("kEquip").textContent = Object.keys(tags).length;
var datas = ANALISES.map(function(a){return a.data;}).sort();
var lastDate = datas.length ? datas[datas.length-1] : "--";
document.getElementById("kData").textContent = lastDate.split("-").reverse().join("/");
document.getElementById("kAnalista").textContent = ANALISES.length ? ANALISES[ANALISES.length-1].analista : "--";
document.getElementById("scCrit").textContent = CRITICOS.length;
document.getElementById("scAten").textContent = ATENCAO.length;
document.getElementById("scOk").textContent   = OK.length;

// =========================================================
// SIDEBAR
// =========================================================
function renderSidebar(list, elId, cls) {
  var el = document.getElementById(elId);
  if (!list.length) {
    el.innerHTML = "<div style='padding:8px 14px;font-size:10px;color:var(--t3)'>Nenhum item</div>";
    return;
  }
  var html = "";
  for (var i = 0; i < list.length; i++) {
    var a = list[i];
    var idx = ANALISES.indexOf(a);
    html += "<div class='item-row' id='row-" + idx + "' onclick='selectItem(" + idx + ")'>" +
      "<div class='ir-dot " + cls + "'></div>" +
      "<div class='ir-body'>" +
        "<div class='ir-tag'>" + a.tag + "</div>" +
        "<div class='ir-sub'>" + a.lado.substring(0,3) + " &bull; " + a.area + " &bull; " + a.horimetro.toLocaleString("pt-BR") + "h</div>" +
      "</div>" +
      "<div class='ir-badge " + cls + "'>" + (a.urgencia ? a.urgencia + "d" : "OK") + "</div>" +
    "</div>";
  }
  el.innerHTML = html;
}
renderSidebar(CRITICOS, "listCrit", "danger");
renderSidebar(ATENCAO,  "listAten", "warn");
renderSidebar(OK,       "listOk",   "ok");

// =========================================================
// DETAIL
// =========================================================
var currentIdx = null;
var chatHistory = [];

function selectItem(idx) {
  currentIdx = idx;
  var a = ANALISES[idx];
  var rows = document.querySelectorAll(".item-row");
  for (var i = 0; i < rows.length; i++) rows[i].classList.remove("active");
  var row = document.getElementById("row-" + idx);
  if (row) row.classList.add("active");
  renderDetail(a);
}

function vidaColor(pct) {
  return pct > 90 ? "var(--danger)" : pct > 75 ? "var(--warn)" : "var(--ok)";
}

function renderDetail(a) {
  var vc = vidaColor(a.pctVida);
  var P = a.P;

  var comps = [
    {k:"Roda Guia",   v:a.roda_guia,  p:P.roda_guia},
    {k:"Elo",         v:a.elo,        p:P.elo},
    {k:"Motriz",      v:a.motriz,     p:P.motriz},
    {k:"Sapata",      v:a.sapata,     p:P.sapata},
    {k:"Passo",       v:a.passo,      p:P.passo},
    {k:"Bucha",       v:a.bucha,      p:P.bucha},
    {k:"Rolete Inf.", v:a.rolete_inf, p:P.rolete_inf},
    {k:"Danificados", v:a.danif,      p:{novo:0, limite:P.danif_critico, tipo:"max", unit:"un"}}
  ];

  var medsHtml = "";
  for (var i = 0; i < comps.length; i++) {
    var c = comps[i];
    if (c.v == null) continue;
    var bad = isBad(c.v, c.p);
    var deg = pctDeg(c.v, c.p.novo, c.p.limite);
    var dc = deg > 85 ? "var(--danger)" : deg > 60 ? "var(--warn)" : "var(--ok)";
    var dv = null;
    var kl = c.k.toLowerCase().split(" ")[0];
    for (var j = 0; j < a.desvios.length; j++) {
      if (a.desvios[j].campo.toLowerCase().indexOf(kl) >= 0) { dv = a.desvios[j]; break; }
    }
    var limLabel = c.p.tipo === "min" ? "lim&gt;=" : "lim&lt;=";
    medsHtml +=
      "<div class='med-card" + (bad ? " bad" : "") + "'>" +
        (bad ? "<div class='med-dev'>+" + (dv ? dv.desvio_pct : "?") + "%</div>" : "") +
        "<div class='med-label'>" + c.k + "</div>" +
        "<div class='med-val" + (bad ? " bad" : "") + "'>" + c.v + "</div>" +
        "<div class='med-unit'>" + c.p.unit + " &bull; " + limLabel + c.p.limite + " &bull; novo:" + c.p.novo + "</div>" +
        "<div style='margin-top:5px'>" +
          "<div style='display:flex;justify-content:space-between;margin-bottom:2px'>" +
            "<span style='font-family:var(--mono);font-size:7px;color:var(--t3)'>DESGASTE</span>" +
            "<span style='font-family:var(--mono);font-size:7px;color:" + dc + "'>" + deg + "%</span>" +
          "</div>" +
          "<div style='height:3px;background:var(--border);border-radius:2px;overflow:hidden'>" +
            "<div style='height:100%;width:" + deg + "%;background:" + dc + ";border-radius:2px;transition:width .5s'></div>" +
          "</div>" +
        "</div>" +
      "</div>";
  }

  var rolSupHtml = "";
  for (var i = 0; i < a.rol_sup.length; i++) {
    var v = a.rol_sup[i];
    var bad = isBad(v, P.rolete_sup);
    var deg = pctDeg(v, P.rolete_sup.novo, P.rolete_sup.limite);
    var dc = deg > 85 ? "var(--danger)" : deg > 60 ? "var(--warn)" : "var(--ok)";
    rolSupHtml +=
      "<div class='rol-chip" + (bad ? " bad" : "") + "'>" +
        "<div class='rol-chip-label'>RS" + (i+1) + "</div>" +
        "<div class='rol-chip-val'>" + v + "</div>" +
        "<div style='height:2px;background:var(--border);border-radius:1px;margin-top:4px;overflow:hidden'>" +
          "<div style='height:100%;width:" + deg + "%;background:" + dc + ";border-radius:1px'></div>" +
        "</div>" +
        "<div style='font-family:var(--mono);font-size:6px;color:" + dc + ";text-align:center;margin-top:2px'>" + deg + "%</div>" +
      "</div>";
  }

  var desviosHtml;
  if (a.desvios.length) {
    desviosHtml = "<div style='margin-bottom:20px'><div class='st'>Desvios detectados (" + a.desvios.length + ")</div>";
    for (var i = 0; i < a.desvios.length; i++) {
      var d = a.desvios[i];
      desviosHtml +=
        "<div class='dev-row'>" +
          "<div class='dev-label'>" + d.campo + "</div>" +
          "<div style='font-family:var(--mono);font-size:9px;color:var(--t3);white-space:nowrap'>" + d.medido + " / lim:" + d.limite + "</div>" +
          "<div class='dev-bar'><div class='dev-fill' style='width:" + Math.min(d.desvio_pct * 4, 100) + "%;background:var(--danger)'></div></div>" +
          "<div class='dev-pct'>+" + d.desvio_pct + "%</div>" +
        "</div>";
    }
    desviosHtml += "</div>";
  } else {
    desviosHtml = "<div style='margin-bottom:20px;padding:10px;background:var(--s1);border:1px solid var(--border);border-radius:4px;font-size:11px;color:var(--ok)'>&#10003; Todos os componentes dentro dos parametros do fabricante</div>";
  }

  var urgHtml = "";
  if (a.urgencia) {
    urgHtml = "<div><div class='urgencia-label'>SUBSTITUIR EM ATE</div>" +
      "<div class='urgencia " + a.cls + "'>" + a.urgencia + " DIAS</div></div>";
  }

  document.getElementById("mainPanel").innerHTML =
    "<div class='detail'>" +
      "<div class='dh'>" +
        "<div>" +
          "<div class='dh-tag'>" + a.tag + "</div>" +
          "<div class='dh-modelo'>" + a.modelo + " &bull; OM " + a.om + "</div>" +
          "<div class='dh-meta'>" +
            "<span>" + a.area + "</span>" +
            "<span>" + a.data + "</span>" +
            "<span>" + a.lado + "</span>" +
            "<span>" + a.analista + "</span>" +
            "<span>" + a.horimetro.toLocaleString("pt-BR") + "h</span>" +
          "</div>" +
        "</div>" +
        "<div class='dh-right'><div class='status-big " + a.cls + "'>" + a.status + "</div>" + urgHtml + "</div>" +
      "</div>" +
      "<div class='vida-row'>" +
        "<div class='vida-label'>VIDA UTIL &bull; " + a.horimetro.toLocaleString("pt-BR") + "h / " + P.vida_util.toLocaleString("pt-BR") + "h</div>" +
        "<div class='vida-bar'><div class='vida-fill' style='width:" + Math.min(a.pctVida,100) + "%;background:" + vc + "'></div></div>" +
        "<div class='vida-pct' style='color:" + vc + "'>" + a.pctVida + "%</div>" +
      "</div>" +
      "<div class='st'>Roletes Superiores &bull; novo " + P.rolete_sup.novo + "mm &bull; limite " + P.rolete_sup.limite + "mm</div>" +
      "<div class='rol-sup-row'>" + rolSupHtml + "</div>" +
      "<div class='st'>Componentes &bull; medicao vs. parametros do fabricante</div>" +
      "<div class='med-grid'>" + medsHtml + "</div>" +
      desviosHtml +
    "</div>";
}

// =========================================================
// CHAT
// =========================================================
function addMsg(txt, role) {
  var el = document.getElementById("chatMsgs");
  var d = document.createElement("div");
  d.className = "msg " + role;
  d.textContent = txt;
  el.appendChild(d);
  el.scrollTop = el.scrollHeight;
  return d;
}

function qask(t) { document.getElementById("ci").value = t; send(); }

async function send() {
  var ci = document.getElementById("ci");
  var btn = document.getElementById("csbtn");
  var txt = ci.value.trim();
  if (!txt) return;
  addMsg(txt, "user");
  ci.value = "";
  btn.disabled = true;

  var sel = currentIdx != null ? ANALISES[currentIdx] : null;
  var critStr = CRITICOS.map(function(a){
    return a.tag + " [" + a.lado.substring(0,3) + "] | " + a.horimetro.toLocaleString() + "h (" + a.pctVida + "% vida) | " +
      a.desvios.map(function(d){return d.campo + " +" + d.desvio_pct + "%";}).join(", ");
  }).join("\n");
  var atenStr = ATENCAO.map(function(a){
    return a.tag + " [" + a.lado.substring(0,3) + "] | " + a.horimetro.toLocaleString() + "h (" + a.pctVida + "% vida)";
  }).join("\n");

  var ctx = "SISTEMA: Material Rodante GD - Pit Viper DR416i + FlexiROC D65\n\n" +
    "PARAMETROS FABRICANTE DR416i: Roda Guia novo=22.5/limite=34.5 | Elo 155.5/142.5 | Motriz 284/270 | Rolete Sup 190/167.5 | Sapata 85/70.6 | Passo max=1055.5 | Bucha 14/10.7 | Rolete Inf 73.9/61.2\n\n" +
    "RESUMO: Total=" + ANALISES.length + " | Criticos=" + CRITICOS.length + " | Atencao=" + ATENCAO.length + " | OK=" + OK.length + "\n\n" +
    "CRITICOS:\n" + (critStr || "Nenhum") + "\n\n" +
    "ATENCAO:\n" + (atenStr || "Nenhum") + "\n\n" +
    (sel ? "ITEM SELECIONADO: TAG=" + sel.tag + " | " + sel.lado + " | " + sel.status + " | desvios=" + sel.desvios.map(function(d){return d.campo;}).join(", ") + "\n\n" : "") +
    "PERGUNTA: " + txt;

  chatHistory.push({role:"user", content:ctx});
  var loading = addMsg("Analisando...", "loading");

  try {
    var resp = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        system: "Voce e especialista em PCM e inspecao de material rodante de perfuratrizes Pit Viper DR416i e FlexiROC D65. Os parametros usados sao os reais do fabricante (lista Parametros do Microsoft Lists). Responda de forma tecnica e objetiva para o time de manutencao de mineracao. 'Novo' = valor da peca nova; 'Limite de desgaste' = ponto de substituicao obrigatorio.",
        messages: chatHistory
      })
    });
    var data = await resp.json();
    var ans = (data.content && data.content[0]) ? data.content[0].text : "Erro ao processar.";
    loading.remove();
    addMsg(ans, "agent");
    chatHistory.push({role:"assistant", content:ans});
  } catch(e) {
    loading.remove();
    addMsg("Erro de conexao com a API.", "loading");
  }
  btn.disabled = false;
}
</script>
</body>
</html>
